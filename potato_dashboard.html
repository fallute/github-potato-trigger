<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“Š Market Intelligence</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --table-border-color: #87ceeb;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      background-color: white;
      color: #000;
    }

    body.dark {
      background-color: #1e1e1e;
      color: #f1f1f1;
    }

    body.dark .content {
      background-color: #1e1e1e;
    }

    body {
    opacity: 0;
    transition: opacity 0.5s ease-in;
  }

  body.fade-in {
    opacity: 1;
  }

    .glow-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
      background-color: #87ceeb;
      transition: background-color 1.2s ease;
    }

    .sidebar {
      width: 240px;
      background-color: #ffffff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 30px 10px;
      display: flex;
      flex-direction: column;
      justify-content: start;
      gap: 20px;
      position: relative;
      z-index: 1;
      padding-bottom: 80px;
    }

    body.dark .sidebar {
      background-color: #2c2c2c;
    }

    .sidebar button,
    .sidebar h2,
    .sidebar .highlight-label {
      width: 100%;
      text-align: center;
    }

    .sidebar h2 {
      font-size: 1.4em;
      margin-top: 40px;
      margin-bottom: 6px;
    }

    .sidebar button {
      padding: 10px;
      font-family: inherit;
      font-weight: normal;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: border 0.3s, background 0.3s;
    }

    .sidebar button:hover {
      background-color: #ddd;
    }

    .sidebar .site-btn {
      border: none;
    }

    .sidebar .highlight-label {
      font-size: 1.4em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #ffc107;
      padding-bottom: 6px;
      margin-bottom: -10px;
      color: #c87b00;
    }

    .sidebar h2.highlight-label {
      color: #000;
      border-bottom: 2px solid rgba(0, 0, 0, 0.4);
    }

    #calculateBtn, #refreshBtn {
      position: relative;
      overflow: hidden;
      color: #fff !important;
      font-weight: normal;
      box-shadow: 0 2px 6px rgba(0,0,0,0.10);
      border: none;
      transition: color 0.3s ease !important;
      background: linear-gradient(to right, #00b4db, #0083b0);
    }

    #calculateBtn:hover, #refreshBtn:hover {
      color: #000 !important;
    }

    #calculateBtn::before, #refreshBtn::before {
      content: "Calculate";
      position: absolute;
      left: 100%;
      top: 0;
      height: 100%;
      width: 100%;
      background: #ff4e50;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font: inherit;
      color: #fff !important;
      transition: left 0.3s ease;
      z-index: 2;
    }

    #refreshBtn::before {
      content: "Refresh Prices";
    }

    #calculateBtn:hover::before, #refreshBtn:hover::before {
      left: 0;
      color: #000 !important;
    }

    #calculateBtn:not(.active)::after {
      content: "";
      position: absolute;
      top: 0;
      left: -75%;
      width: 50%;
      height: 100%;
      background: linear-gradient(120deg, rgba(255,255,255,0.1), rgba(255,255,255,0.4), rgba(255,255,255,0.1));
      transform: skewX(-20deg);
      animation: shimmer 2.5s infinite;
      z-index: 1;
    }

    @keyframes shimmer {
      0% { left: -75%; }
      100% { left: 125%; }
    }

    #darkToggle {
      position: fixed;
      top: 10px;
      right: 30px;
      z-index: 999;
      color: #000;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .content {
      flex: 1;
      margin: 0.1rem;
      height: calc(100% - 0.2rem);
      background: white;
      overflow: hidden;
      display: flex;
      z-index: 1;
      position: relative;
    }

    .main {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .main::-webkit-scrollbar {
      display: none;
    }

    h1 {
      text-align: center;
      font-size: 2.5em;
      position: relative;
      top: -20px;
    }

    .chart-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      margin-top: 35px;
    }

    #chartTableWrapper {
      width: 95%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .scroll-chart {
      width: 100%;
      overflow-x: auto;
      padding: 0;
    }

    .chart-wrapper {
      min-width: 1100px;
      background: white;
      border-radius: 10px;
      padding: 10px;
      border: 2px solid #87ceeb;
      transition: border-color 0.4s ease;
      position: relative;
    }

    body.dark .chart-wrapper {
      background-color: #2c2c2c;
    }

    canvas {
      width: 100%;
      height: 440px !important;
      display: block;
    }

#downloadChartBtn,
#downloadTableBtn {
  transition: all 0.2s ease !important;
  border-radius: 5px !important;
}
    
#downloadChartBtn:hover,
#downloadTableBtn:hover {
  background-color: #f0f0f0 !important;
  color: #000 !important;
}

#downloadChartBtn:active,
#downloadTableBtn:active {
  background-color: #e0e0e0 !important;
  transform: scale(0.98) !important;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1) !important;
}


    #dataTable {
      border: 2px solid var(--table-border-color);
      border-radius: 10px;
      margin-top: 20px;
      overflow: hidden;
      transition: border-color 0.4s ease;
      border-collapse: separate;
      border-spacing: 0;
      width: 95%;
    }

    #dataTable thead tr {
      border-bottom: 2px solid var(--table-border-color);
    }

    #dataTable th, #dataTable td {
      padding: 12px;
      text-align: left;
    }

    #dataTable tbody td {
      border-bottom: 0.5px solid color-mix(in srgb, var(--table-border-color) 50%, transparent);
    }

    #dataTable th {
      background-color: color-mix(in srgb, var(--table-border-color) 20%, white);
      border-bottom: 2px solid var(--table-border-color);
    }

    body.dark #dataTable th {
      background-color: color-mix(in srgb, var(--table-border-color) 20%, black);
    }

    .dropdown-wrapper,
    .toggle-wrapper {
      position: absolute;
      z-index: 2;
    }

    .dropdown-wrapper {
      top: 10px;
      right: 10px;
    }

    .dropdown-wrapper select {
      font-size: 16px;
      font-family: inherit;
      font-weight: normal;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      cursor: pointer;
      width: 240px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='16' height='12' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23888' d='M8 12L0 0h16z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 10px;
      transition: border-color 0.4s ease, color 0.4s ease;
    }

    .toggle-wrapper {
      top: 20px;
      left: 18px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .ios-toggle {
      position: relative;
      width: 44px;
      height: 26px;
    }

    .ios-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .ios-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }

    .ios-slider::before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    .ios-toggle input:checked + .ios-slider::before {
      transform: translateX(18px);
    }

   /* Shrink only the two toggles visually */
     #priceUnitToggle + .ios-slider,
     #toggleChartType + .ios-slider {
     transform: scale(0.9);
     transform-origin: left center;
     }

    #dateSelector {
     border: 2px solid #ccc; /* default */
     transition: border-color 0.3s ease;
     }

    .sidebar_buttom {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      padding: 0 10px;
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    #dataTable tr.highlighted td {
      background-color: #ffeb3b !important;
      font-weight: bold;
    }

    #timestamp {
      color: #000;
      font-size: 12px;
      text-align: center;
      line-height: 1.3;
    }

    body.dark #timestamp {
      color: #fff !important;
    }
  </style>
</head>
<body>
  <div class="glow-frame"></div>
  <button id="darkToggle">ðŸŒ™ Dark Mode</button>
  <div class="content">
    <div class="sidebar">
      <div class="highlight-label">Average</div>
      <button id="calculateBtn">Calculate</button>
      <h2 class="highlight-label">Websites</h2>
      <button id="liveBtn" class="site-btn active">commoditymarketlive</button>
      <button id="onlineBtn" class="site-btn">commodityonline</button>
      <button id="mandiBtn" class="site-btn">mandiprices</button>
      <button id="agmarknetBtn" class="site-btn">agmarknet</button>
      <button id="napantaBtn" class="site-btn">napanta</button>

      
      <div class="sidebar_buttom">
        <button id="refreshBtn">Refresh Prices</button>
        <div id="timestamp"></div>
      </div>
    </div>

    <div class="main">
      <h1>Potato Dashboard</h1>
      <div class="chart-container">
        <div id="chartTableWrapper">
          <div class="scroll-chart">
            <div id="chartWrapper" class="chart-wrapper">
               <!-- Fixed inline container so it doesn't stretch chartWrapper -->
<div class="dropdown-wrapper" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; align-items: center; z-index: 2;">
  <!-- Price Type Dropdown -->
  <select id="priceType">
    <option value="Current_Price">Current Price</option>
    <option value="Minimum_Price">Minimum Price</option>
    <option value="Maximum_Price">Maximum Price</option>
  </select>

  <!-- 3-dot Menu -->
  <div style="position: relative;">
    <button id="dropdownToggleBtn" style="
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 3px 6px;
      font-size: 25px;
      font-family: inherit;
      font-weight: normal;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: border-color 0.4s ease, color 0.4s ease;
    ">â‹®</button>

    <div id="downloadDropdown" style="
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
      min-width: 180px;
    ">
      <button id="downloadChartBtn" onclick="downloadChartImage()" style="
        background: none;
        border: none;
        padding: 8px 16px;
        width: 95%;
        margin: 4px auto;
        display: block;
        text-align: left;
        font-family: inherit;
        font-size: 14px;
        font-weight: normal;
        cursor: pointer;
      ">Download Chart</button>
      <button id="downloadTableBtn" onclick="downloadTableImage()" style="
        background: none;
        border: none;
        padding: 8px 16px;
        width: 95%;
        margin: 4px auto;
        display: block;
        text-align: left;
        font-family: inherit;
        font-size: 14px;
        font-weight: normal;
        cursor: pointer;
      ">Download Table</button>
    </div>
  </div>
</div>
 
              <div class="toggle-wrapper">
                <div class="toggle-group">
                  <label class="ios-toggle">
                    <input type="checkbox" id="toggleChartType">
                    <span class="ios-slider"></span>
                  </label>
                  <span id="chartTypeLabel">Line Chart</span>
                </div>
                
                <div class="toggle-group">
                  <label class="ios-toggle">
                    <input type="checkbox" id="priceUnitToggle">
                    <span class="ios-slider"></span>
                  </label>
                  <span id="priceUnitLabel">Per KG</span>
                  <input type="date" id="dateSelector" style="
                   margin-left: 18px;
                   font-size: 14px;
                   padding: 6px 10px;
                   border-radius: 6px;
                   border: 1px solid #ccc;
                   background-color: #fff;
                   cursor: pointer;
                   max-width: 180px;
                  ">

                </div>
              </div>
  <div id ="lineTarget" style="
  width: 14px;
  height: 14px;
  margin-left: -10px;
  margin-top: 5px;
  z-index: 2;
  position: absolute;
"></div>


              <canvas id="mainChart"></canvas>
            </div>
          </div>
        </div>

          <table id="dataTable"></table>
        </div>
      </div>
    </div>
  </div>

<div id="logModal" style="
  display: none;
  pointer-events: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.7);  /* âœ… back to original black glass */
  backdrop-filter: blur(4px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  overflow: hidden;
">

<div id="logCard" style="
  position: relative;
  background: rgba(255, 255, 255, 0.90);         /* soft white */
  border: 1px solid rgba(255, 255, 255, 0.3);     /* faint white border */
  box-shadow:
    inset 0 0 12px rgba(255, 255, 255, 0.25),     /* inner glow */
    0 8px 32px rgba(0, 0, 0, 0.15);               /* outer shadow for depth */
  border-radius: 16px;
  padding: 20px;
  width: 600px;
  max-height: 70vh;
  font-family: Consolas, monospace;
  overflow: hidden;
">

<!-- Refresh label (bottom right of log card) -->
<div id="refreshLabel" onclick="refreshScraper()" style="
  display: none;
  position: absolute;
  bottom: 14px;
  right: 18px;
  font-size: 14px;
  font-weight: 500;
  color: #222;
  cursor: pointer;
  user-select: none;
  background: none;
  border: none;
  box-shadow: none;
  z-index: 3;
">
  <span style="font-size: 18px; margin-right: 6px;">&#x21bb;</span>Refresh
</div>

    <!-- Top-right dynamic button -->
<button id="stopBtn" onclick="stopScraper()" style="
  position: absolute;
  top: 10px;
  right: 10px;
  background: transparent;
  border: none;
  color: #222;
  font-weight: 500;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  z-index: 2;
">Stop</button>

<!-- Close button -->
<button id="closeBtn" onclick="hideLogModal()" style="
  display: none;
  position: absolute;
  top: 10px;
  right: 10px;
  background: transparent;
  border: none;
  color: #222;
  text-shadow: 0 0 2px rgba(0,0,0,0.2);
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  z-index: 2;
">âœ–</button>



    <!-- Show Logs Toggle (Top-Left) -->
<div style="position: absolute; top: 10px; left: 10px; display: flex; align-items: center; gap: 8px;">
  <label style="color: #222; font-size: 14px; font-weight: 500;">Show Logs</label>
  <label class="switch">
    <input type="checkbox" id="logToggle" onchange="toggleLogVisibility()">
    <span class="slider round" id="logToggleSlider"></span>
  </label>
</div>


   <!-- Spinner/Icon + status -->
<div style="text-align: center; margin-top: 25px;">
  <div id="spinnerContainer" style="height: 30px; display: flex; justify-content: center; align-items: center;">
    <div class="spinner" id="spinnerRing" style="
  border: 4px solid #333;
  border-top: 4px solid #0f0;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: auto;
"></div>

    <div id="resultIcon" style="display: none; font-size: 28px;"></div>
  </div>
  <div id="statusLabel" style="
    font-size: 14px;
    color: #222;
    font-weight: 500;
    margin-top: 8px;
  ">Loading Dataâ€¦</div>
</div>


    <!-- Logs -->
    <pre id="logBox" style="
      margin: 0;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
    "></pre>
  </div>
</div>

<style>
@keyframes spin { 0% {transform:rotate(0deg)} 100% {transform:rotate(360deg)} }

#logBox {
  scrollbar-width: none;
  color: #007bff; /* default fallback */
  text-shadow: 0 0 6px #007bff88;
}
#logBox::-webkit-scrollbar {
  display: none;
}


/* iOS toggle (unchanged)â€¦ */
.switch{position:relative;display:inline-block;width:36px;height:20px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#444;transition:.3s;border-radius:34px}
.slider:before{position:absolute;content:"";height:14px;width:14px;left:3px;bottom:3px;background:#fff;transition:.3s;border-radius:50%}
input:checked+.slider{background:#0f0}
input:checked+.slider:before{transform:translateX(16px)}

</style>

<svg id="curveConnector" width="100%" height="100%" style="
  position: fixed;
  top: 0;
  left: 0;
  pointer-events: none;
  z-index: 1000;
">
  <path id="connectorPath"
      stroke="#87ceeb"
      stroke-width="2"
      fill="none"/>
</svg>

<style>
  @keyframes drawLine {
  from {
    stroke-dashoffset: var(--path-length, 1000);
  }
  to {
    stroke-dashoffset: 0;
  }
}
  #connectorPath {
     transition: stroke 0.4s ease;
}
</style>


<script>
  Chart.register(ChartDataLabels);

  let liveJson = {}, onlineJson = {}, mandiJson = {}, combinedJson = {}, agmarknetJson = {}, napantaJson = {}; allowedDates = [];
  
  const LIVE_URL = "https://fallute.github.io/potato-scraper/docs/result_commoditymarketlive_in.json";
  const ONLINE_URL = "https://fallute.github.io/potato-scraper/docs/result_commodityonline_in.json";
  const MANDI_URL = "https://fallute.github.io/potato-scraper/docs/result_mandiprices_in.json";
  const AGRMARKNET_URL = "https://fallute.github.io/potato-scraper/docs/result_agmarknet_gov_in.json";
  const NAPANTA_URL = "https://fallute.github.io/potato-scraper/docs/result_napanta_com.json";
  const COMBINED_URL = "https://fallute.github.io/potato-scraper/docs/combined_averages.json";
  const TIMESTAMP_URL = "https://fallute.github.io/potato-scraper/docs/run_timestamp.json";

  const priceTypeSelect = document.getElementById("priceType");
  const toggleChartTypeCheckbox = document.getElementById("toggleChartType");
  const chartTypeLabel = document.getElementById("chartTypeLabel");
  const iosSliders = document.querySelectorAll(".toggle-wrapper .ios-slider");
  const liveBtn = document.getElementById("liveBtn");
  const onlineBtn = document.getElementById("onlineBtn");
  const mandiBtn = document.getElementById("mandiBtn");
  const agmarknetBtn = document.getElementById("agmarknetBtn");
  const napantaBtn = document.getElementById("napantaBtn");
  const calculateBtn = document.getElementById("calculateBtn");
  const canvasEl = document.getElementById("mainChart");
  const chartWrapper = document.getElementById("chartWrapper");
  const darkToggle = document.getElementById("darkToggle");
  const dataTable = document.getElementById("dataTable");
  const refreshBtn = document.getElementById("refreshBtn");
  const priceUnitToggle = document.getElementById("priceUnitToggle");
  const priceUnitLabel = document.getElementById("priceUnitLabel");
  const timestampElement = document.getElementById("timestamp");

  let liveData = [], onlineData = [], mandiData = [], combinedData = [], agmarknetData = [], napantaData = [], mainChart;
  let activeSource = "commoditymarketlive";
  let chartType = "bar";

  function getColor(type) {
    return type === "Current_Price" ? "#87ceeb" :
           type === "Minimum_Price" ? "#59a14f" :
           "#e15759";
  }

  function lightenColor(hex) {
    if (hex === "#87ceeb") return "#cfe9f7";
    const amt = 35;
    const col = hex.replace("#", "");
    const r = Math.min(255, parseInt(col.substring(0, 2), 16) + amt);
    const g = Math.min(255, parseInt(col.substring(2, 4), 16) + amt);
    const b = Math.min(255, parseInt(col.substring(4, 6), 16) + amt);
    return `rgb(${r},${g},${b})`;
  }

  function getContrastColor(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000' : '#fff';
  }

  function getButtonGradient(priceType) {
    switch(priceType) {
      case 'Minimum_Price': return 'linear-gradient(to right, #00b09b, #96c93d)';
      case 'Maximum_Price': return 'linear-gradient(to right, #f85032, #e73827)';
      default: return 'linear-gradient(to right, #00b4db, #0083b0)';
    }
  }

  function updateButtonColors(priceType) {
    const gradient = getButtonGradient(priceType);
    [calculateBtn, refreshBtn].forEach(btn => btn.style.background = gradient);
  }

  function updateGlowColor(priceType) {
    document.querySelector(".glow-frame").style.backgroundColor = getColor(priceType);
  }

  function updateBorderColor(priceType) {
    const color = getColor(priceType);
    const isCurrentPrice = priceType === 'Current_Price';
    const toggleColor = isCurrentPrice ? lightenColor(color) : color;

    darkToggle.style.backgroundColor = toggleColor;
    darkToggle.style.color = '#000';
    chartWrapper.style.borderColor = color;
    priceTypeSelect.style.borderColor = color;
    document.getElementById("dateSelector").style.borderColor = color;
    
    iosSliders.forEach(slider => slider.style.backgroundColor = color);
    const activeBtn = document.querySelector(".site-btn.active");
    if (activeBtn) activeBtn.style.border = `2px solid ${color}`;
    
    document.documentElement.style.setProperty('--table-border-color', color);
    updateGlowColor(priceType);
    updateButtonColors(priceType);

    // Update download Chart button border color
    const downloadCBtn = document.getElementById("downloadChartBtn");
    if (downloadCBtn) downloadCBtn.style.borderColor = color;

    // Update download Table button border color
    const downloadTBtn = document.getElementById("downloadTableBtn");
    if (downloadTBtn) downloadTBtn.style.borderColor = color;

    document.getElementById("dropdownToggleBtn").style.borderColor = color; 
  }

  function updateTable(data) {
    const divideFactor = priceUnitToggle.checked ? 1 : 100;
    const decimals = priceUnitToggle.checked ? 0 : 1;

    dataTable.innerHTML = `
      <thead>
        <tr>
          <th>State</th>
          <th>Current Price</th>
          <th>Minimum Price</th>
          <th>Maximum Price</th>
        </tr>
      </thead>
      <tbody>
        ${data.map(d => ` 
          <tr>
            <td>${d.State}</td>
            <td>â‚¹${(d.Current_Price / divideFactor).toFixed(decimals)}</td>
            <td>â‚¹${(d.Minimum_Price / divideFactor).toFixed(decimals)}</td>
            <td>â‚¹${(d.Maximum_Price / divideFactor).toFixed(decimals)}</td>
          </tr>
        `).join("")}
      </tbody>
    `;
  }

  function clearSiteButtonBorders() {
    document.querySelectorAll(".site-btn").forEach(btn => {
      btn.classList.remove("active");
      btn.style.border = "none";
    });
    calculateBtn.classList.remove('active');
    calculateBtn.style.border = "none";
  }

  function highlightTableRow(state) {
    const rows = dataTable.getElementsByTagName('tr');
    Array.from(rows).forEach(row => {
      const stateCell = row.querySelector('td:first-child');
      row.classList.toggle('highlighted', stateCell?.textContent === state);
    });
  }

  function updateChart() {
    if (mainChart) mainChart.destroy();
    const ctx = canvasEl.getContext("2d");
    const priceType = priceTypeSelect.value;
    const isDark = document.body.classList.contains("dark");
    const color = getColor(priceType);
    const divideFactor = priceUnitToggle.checked ? 1 : 100;
    const decimals = priceUnitToggle.checked ? 0 : 1;
    updateBorderColor(priceType);

    let data = [], label = "";
    if (activeSource === "commoditymarketlive") data = liveData, label = "commoditymarketlive";
    if (activeSource === "commodityonline") data = onlineData, label = "commodityonline";
    if (activeSource === "mandiprices") data = mandiData, label = "mandiprices";
    if (activeSource === "agmarknet") data = agmarknetData, label = "agmarknet";
    if (activeSource === "napanta") data = napantaData, label = "napanta";
    if (activeSource === "Comparison") data = combinedData, label = "Average";

    const chartData = {
      labels: data.map(d => d.State),
      datasets: [{
        label: `${label} - ${priceType.replace("_", " ")}/${priceUnitToggle.checked ? 'Quintal' : 'KG'}`,
        data: data.map(d => d[priceType] / divideFactor),
        backgroundColor: color,
        borderColor: color,
        hoverBackgroundColor: '#ffc107',
        hoverBorderColor: '#ff9800',
        borderWidth: 2,
        fill: false
      }]
    };

    const maxVal = Math.max(...data.map(d => d[priceType] / divideFactor).filter(v => v != null)) || 100;

    mainChart = new Chart(ctx, {
      type: chartType,
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 22, bottom: 20, left: 5, right: 5 } },
        onClick: (e, elements) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const state = mainChart.data.labels[index];
            highlightTableRow(state);
          }
        },
        plugins: {
          title: {
            display: true,
            padding: { top: -10, bottom: 0 },
            text: label,
            font: { 
              size: 24,
              weight: 'bold'
            },
            color: isDark ? "#fff" : "#555"
          },
          subtitle: {
            display: true,
            padding: { top: 5, bottom: 13 },
            text: `${priceType.replace('_', ' ')}/${priceUnitToggle.checked ? 'Quintal' : 'KG'}`,
            font: {
              size: 17,
              weight: 'normal'
            },
            color: isDark ? "#ccc" : "#777"
          },
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'top',
            offset: 6,
            color: isDark ? "#fff" : "#000",
            font: { weight: 'bold', size: 12 },
            formatter: v => v != null ? v.toFixed(decimals) : ""
          },
          tooltip: {
            callbacks: {
              label: ctx => `â‚¹ ${ctx.parsed.y.toFixed(decimals)}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            suggestedMax: maxVal * 1.15,
            title: {
              display: true,
              text: `â‚¹ Price/${priceUnitToggle.checked ? 'Quintal' : 'KG'}`,
              font: { size: 15 },
              color: isDark ? "#fff" : "#555"
            },
            ticks: {
              font: { size: 13 },
              color: isDark ? "#ccc" : "#555"
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 30,
              font: { size: 11 },
              autoSkip: false,
              color: isDark ? "#ccc" : "#555"
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    updateTable(data);  
  }

  priceTypeSelect.addEventListener("change", () => {
    if (activeSource === "Comparison") calculateBtn.style.border = `2.5px solid ${getColor(priceTypeSelect.value)}`;
    updateChart();
    drawConnectorLine(false);
  });

  toggleChartTypeCheckbox.addEventListener("change", () => {
    chartType = chartType === "bar" ? "line" : "bar";
    chartTypeLabel.textContent = chartType === "bar" ? "Line Chart" : "Bar Chart";
    updateChart();
  });

  liveBtn.addEventListener("click", () => {
    activeSource = "commoditymarketlive";
    clearSiteButtonBorders();
    liveBtn.classList.add("active");
    updateChart();
    drawConnectorLine(true);
  });

  onlineBtn.addEventListener("click", () => {
    activeSource = "commodityonline";
    clearSiteButtonBorders();
    onlineBtn.classList.add("active");
    updateChart();
    drawConnectorLine(true);
  });

  mandiBtn.addEventListener("click", () => {
    activeSource = "mandiprices";
    clearSiteButtonBorders();
    mandiBtn.classList.add("active");
    updateChart();
    drawConnectorLine(true);
  });

  agmarknetBtn.addEventListener("click", () => {
    activeSource = "agmarknet";
    clearSiteButtonBorders();
    agmarknetBtn.classList.add("active");
    agmarknetBtn.style.border = `2px solid ${getColor(priceTypeSelect.value)}`;
    updateChart();
    drawConnectorLine(true);
  });

 napantaBtn.addEventListener("click", () => {
  activeSource = "napanta";
  clearSiteButtonBorders();
  napantaBtn.classList.add("active");
  napantaBtn.style.border = `2px solid ${getColor(priceTypeSelect.value)}`;
  updateChart();
  drawConnectorLine(true);
 });

  calculateBtn.addEventListener("click", () => {
    if (combinedData.length === 0) {
      timestampElement.textContent = "Combined data not loaded. Please refresh the page.";
      return;
    }
    activeSource = "Comparison";
    clearSiteButtonBorders();
    calculateBtn.classList.add('active');
    calculateBtn.style.border = `2.5px solid ${getColor(priceTypeSelect.value)}`;
    updateChart();
    drawConnectorLine(true);
  });

  darkToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    darkToggle.textContent = document.body.classList.contains("dark") ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
    updateChart();
  });

  priceUnitToggle.addEventListener("change", () => {
    priceUnitLabel.textContent = priceUnitToggle.checked ? "Per Quintal" : "Per KG";
    updateChart();
  });
  
  async function fetchData() {
    try {
      const [liveRes, onlineRes, mandiRes, combinedRes, timestampRes, agmarknetRes, napantaRes] = await Promise.all([
        fetch(LIVE_URL),
        fetch(ONLINE_URL),
        fetch(MANDI_URL),
        fetch(COMBINED_URL),
        fetch(TIMESTAMP_URL),
        fetch(AGRMARKNET_URL),
        fetch(NAPANTA_URL)
      ]);

      liveJson = await liveRes.json();
      onlineJson = await onlineRes.json();
      mandiJson = await mandiRes.json();
      combinedJson = await combinedRes.json();
      agmarknetJson = await agmarknetRes.json();
      napantaJson = await napantaRes.json();

      const allDates = Object.keys(liveJson)
        .filter(date => onlineJson[date] && mandiJson[date] && combinedJson[date] && agmarknetJson[date] && napantaJson[date])
        .sort()
        .reverse();
      allowedDates = allDates;

      const selector = document.getElementById("dateSelector");
      selector.setAttribute("min", allDates[allDates.length - 1]);
      selector.setAttribute("max", allDates[0]);
      const latest = allDates[0];
      selector.value = latest;

      liveData = liveJson[latest];
      onlineData = onlineJson[latest];
      mandiData = mandiJson[latest];
      combinedData = combinedJson[latest];
      agmarknetData = agmarknetJson[latest];
      napantaData = napantaJson[latest]

      const { last_run } = await timestampRes.json();
      const date = new Date(last_run);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      let hours = date.getHours();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      const formatted = `${day}/${month}/${year} ${String(hours).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')} ${ampm}`;
      timestampElement.textContent = `Last Updated: ${formatted}`;

      updateChart();
    } catch (error) {
      console.error('Error fetching data:', error);
      timestampElement.textContent = "Failed to load data. Please try again later.";
    }
  }

  refreshBtn.addEventListener("click", async () => {
    if (window.pywebview) {
      showLogModal();
      refreshBtn.disabled = true;
      refreshBtn.textContent = "Refreshing...";
      await window.pywebview.api.run_scraper();
      refreshBtn.textContent = "Refresh Prices";
      refreshBtn.disabled = false;
    } else {
      alert("PyWebView not available.");
    }
  })

  function showLogModal() {
    const modal = document.getElementById("logModal");
    modal.style.display = "flex";
    modal.style.pointerEvents = "auto";
    document.getElementById("logBox").textContent = "";

    const toggle = document.getElementById("logToggle");
    toggle.checked = false;
    toggleLogVisibility();

    document.getElementById("statusLabel").textContent = "Loading Dataâ€¦";
    document.getElementById("statusLabel").style.color = "#ccc";
    document.getElementById("spinnerRing").style.display = "block";
    document.getElementById("resultIcon").style.display = "none";
    document.getElementById("stopBtn").style.display = "inline-block";
    document.getElementById("closeBtn").style.display = "none";

    updateLogThemeFromPriceType();
  }

  function hideLogModal() {
    const modal = document.getElementById("logModal");
    modal.style.display = "none";
    modal.style.pointerEvents = "none";
  }

  function appendLog(line) {
    const logBox = document.getElementById("logBox");
    logBox.textContent += line + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }
  
  function toggleLogVisibility() {
    const box = document.getElementById("logBox");
    box.style.display = document.getElementById("logToggle").checked ? "block" : "none";
  }
  
  function stopScraper() {
    if (window.pywebview) {
      window.pywebview.api.stop_scraper();
    }
  }
  
  function updateLogThemeFromPriceType() {
    const selected = document.getElementById("priceType")?.value || "Current_Price";

    const colorMap = {
      "Current_Price": "#007bff",
      "Minimum_Price": "#28a745",
      "Maximum_Price": "#dc3545"
    };
    const rgbaMap = {
      "Current_Price": "rgba(0, 123, 255, 0.35)",
      "Minimum_Price": "rgba(40, 167, 69, 0.35)",
      "Maximum_Price": "rgba(220, 53, 69, 0.35)"
    };

    const color = colorMap[selected] || "#007bff";
    const glow = rgbaMap[selected] || "rgba(0, 123, 255, 0.35)";

    const logBox = document.getElementById("logBox");
    if (logBox) {
      logBox.style.color = color;
    }

    const logCard = document.getElementById("logCard");
    if (logCard) {
      logCard.style.boxShadow = `0 8px 32px ${glow}`;
    }

    const spinner = document.getElementById("spinnerRing");
    if (spinner) {
      spinner.style.borderTop = `4px solid ${color}`;
    }

    const toggleSlider = document.getElementById("logToggleSlider");
    if (toggleSlider) {
      toggleSlider.style.backgroundColor = color;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const dropdown = document.getElementById("priceType");
    if (dropdown) {
      dropdown.addEventListener("change", updateLogThemeFromPriceType);
    }
  });

  function refreshScraper() {
    fetchData().then(() => {
      // Reset to latest date after refresh
      const selector = document.getElementById("dateSelector");
      selector.value = allowedDates[0];
      const event = new Event('change');
      selector.dispatchEvent(event);
      
      hideLogModal();
    }).catch(error => {
      console.error("Reload failed:", error);
    });
  }

  dateSelector.addEventListener("change", () => {
    const d = dateSelector.value;
    if (!allowedDates.includes(d)) {
      alert("No data for selected date.");
      dateSelector.value = allowedDates[0];
      return;
    }
    liveData = liveJson[d];
    onlineData = onlineJson[d];
    mandiData = mandiJson[d];
    combinedData = combinedJson[d];
    agmarknetData = agmarknetJson[d];
    napantaData = napantaJson[d];
    updateChart();
  });

  document.getElementById("dateSelector").addEventListener("click", function (e) {
    if (typeof this.showPicker === "function") {
      this.showPicker();
    }
  });

  document.getElementById("dropdownToggleBtn").addEventListener("click", () => {
  const dropdown = document.getElementById("downloadDropdown");
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
});

document.addEventListener("click", function(e) {
  const dropdown = document.getElementById("downloadDropdown");
  const toggleBtn = document.getElementById("dropdownToggleBtn");
  if (!dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
    dropdown.style.display = "none";
  }
});


  function showRefreshIfSuccess() {
    const label = document.getElementById('refreshLabel');
    const status = document.getElementById('statusLabel');
    if (label && status && status.textContent === 'Success') {
      label.style.color = getComputedStyle(status).color;
      label.style.display = 'inline-block';
    } else if (label) {
      label.style.display = 'none';
    }
  }

  function hideRefreshLabel() {
    const label = document.getElementById('refreshLabel');
    if (label) {
      label.style.display = 'none';
    }
  }

  function downloadChartImage() {
    const canvas = document.getElementById('mainChart');
    if (!canvas) return;

    const base64 = canvas.toDataURL('image/png');
    if (window.pywebview?.api?.saveChartImage) {
      window.pywebview.api.saveChartImage(base64);
    }
    else {
      const a = document.createElement('a');
      a.href = base64;
      a.download = 'market_chart.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  }

  function downloadTableImage() {
  const originalTable = document.getElementById('dataTable');
  if (!originalTable) return;

  // Clone the table
  const clone = originalTable.cloneNode(true);
  clone.style.color = 'black';
  clone.style.backgroundColor = 'white';
  clone.style.border = '1px solid black';
  clone.style.padding = '8px';
  clone.style.fontSize = '14px';
  clone.style.fontFamily = 'Arial, sans-serif';
  clone.style.width = originalTable.offsetWidth + 'px';

  // Force-safe styles for inner elements
  clone.querySelectorAll('*').forEach(el => {
    el.style.color = 'black';
    el.style.backgroundColor = 'white';
    el.style.borderColor = 'black';
  });

  // Create a container and append to body (hidden)
  const container = document.createElement('div');
  container.style.position = 'fixed';
  container.style.top = '-9999px';
  container.style.left = '-9999px';
  container.appendChild(clone);
  document.body.appendChild(container);

  // Now render only the clean clone
  html2canvas(clone)
    .then(canvas => {
      const image = canvas.toDataURL('image/png');

      // Clean up
      document.body.removeChild(container);

      // Download or send to API
      if (window.pywebview?.api?.saveTableImage) {
        window.pywebview.api.saveTableImage(image);
      } else {
        const a = document.createElement('a');
        a.href = image;
        a.download = 'market_table.png';
        a.click();
      }
    })
    .catch(err => {
      console.error("âŒ html2canvas error:", err);
      document.body.removeChild(container);
    });
}

  let previousSource = "";
  function drawConnectorLine(shouldAnimate = true) {
  const activeBtn =
    document.querySelector(".sidebar .site-btn.active") ||
    document.querySelector("#calculateBtn.active");

  const target = document.getElementById("lineTarget");
  const path = document.getElementById("connectorPath");

  if (!activeBtn || !target || !path) return;

  const btnRect = activeBtn.getBoundingClientRect();
  const targetRect = target.getBoundingClientRect();
  const scrollX = window.scrollX;
  const scrollY = window.scrollY;

  const startX = btnRect.right + scrollX;
  const startY = btnRect.top + btnRect.height / 2 + scrollY;
  const endX = targetRect.left + scrollX;
  const endY = targetRect.top + targetRect.height / 2 + scrollY;
  const midX = (startX + endX) / 2;

  const d = `M ${startX},${startY} C ${midX},${startY} ${midX},${endY} ${endX},${endY}`;

  path.setAttribute("d", d);
  path.setAttribute("stroke", getColor(priceTypeSelect.value));

  if (shouldAnimate) {
    const length = path.getTotalLength();
    path.style.transition = "none";
    path.style.strokeDasharray = length;
    path.style.strokeDashoffset = length;
    path.getBoundingClientRect(); // force reflow
    path.style.transition = "stroke-dashoffset 0.8s ease, stroke 0.4s ease";
    path.style.strokeDashoffset = "0";
  } else {
    // Ensure line is fully visible
    path.style.strokeDasharray = "none";
    path.style.strokeDashoffset = "0";
  }
}

  window.addEventListener("resize", () => drawConnectorLine(false));
  window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => drawConnectorLine(false), 300);
});

 window.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('fade-in');
  });

  fetchData();
</script>
</body>
</html>
